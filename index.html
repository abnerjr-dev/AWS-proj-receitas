<!DOCTYPE html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Descobridor de Receitas</title>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <div class="container">
      <h1>üç≥ Descobridor de Receitas</h1>
      <p>Fa√ßa o upload de uma foto dos seus ingredientes e receba sugest√µes de receitas!</p>

      <div class="upload-area" id="uploadArea">
        <span class="upload-icon">üìÅ</span>
        <p>Clique aqui ou arraste uma imagem para esta √°rea</p>
        <input type="file" id="fileInput" accept="image/jpeg, image/png, image/jpg" />
      </div>

      <img id="imagePreview" alt="Pr√©via da imagem selecionada" />

      <button id="uploadButton">Enviar Imagem e Gerar Receita</button>

      <div id="status"></div>

      <div id="resultado"></div>
    </div>

    <script>
      const API_URL = "https://1usbpeqsll.execute-api.us-east-1.amazonaws.com/dev";

      let requestId = null;

      const uploadArea = document.getElementById("uploadArea");
      const fileInput = document.getElementById("fileInput");
      const imagePreview = document.getElementById("imagePreview");
      const uploadButton = document.getElementById("uploadButton");
      const statusDiv = document.getElementById("status");
      const resultadoDiv = document.getElementById("resultado");

      // Event Listeners
      uploadArea.addEventListener("click", () => fileInput.click());
      fileInput.addEventListener("change", handleFileSelect);
      uploadButton.addEventListener("click", uploadImage);
      setupDragAndDrop();

      function handleFileSelect(event) {
        const file = event.target.files[0];
        if (file && isValidImage(file)) {
          showImagePreview(file);
        }
      }

      function isValidImage(file) {
        if (!file.type.match("image/jpeg") && !file.type.match("image/png")) {
          alert("Por favor, selecione um arquivo de imagem (JPEG ou PNG).");
          return false;
        }
        return true;
      }

      function showImagePreview(file) {
        const reader = new FileReader();
        reader.onload = function (e) {
          imagePreview.src = e.target.result;
          imagePreview.style.display = "block";
          uploadButton.style.display = "block";
        };
        reader.readAsDataURL(file);
      }

      function setupDragAndDrop() {
        uploadArea.addEventListener("dragover", (e) => {
          e.preventDefault();
          uploadArea.classList.add("dragover");
        });

        uploadArea.addEventListener("dragleave", () => {
          uploadArea.classList.remove("dragover");
        });

        uploadArea.addEventListener("drop", (e) => {
          e.preventDefault();
          uploadArea.classList.remove("dragover");
          fileInput.files = e.dataTransfer.files;
          const event = new Event("change");
          fileInput.dispatchEvent(event);
        });
      }

      async function uploadImage() {
        const file = fileInput.files[0];
        if (!file) return;

        setUploadState("loading", "Convertendo imagem...");

        try {
          const base64 = await new Promise((resolve) => {
            const reader = new FileReader();
            reader.onload = (e) => resolve(e.target.result);
            reader.readAsDataURL(file);
          });

          const payload = {
            image: base64,
            fileName: file.name,
          };

          console.log("üì§ Enviando imagem...");

          const response = await fetch(`${API_URL}/upload`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(payload),
          });

          const data = await response.json();
          console.log("üì• Resposta do upload:", data);

          if (!response.ok) {
            throw new Error(data.error || `Erro ${response.status}`);
          }

          requestId = data.data.requestId;

          if (requestId) {
            requestId = requestId.trim().replace(/\s+/g, "");
            console.log("üÜî RequestId armazenado:", requestId);
            console.log("üìè Comprimento do requestId:", requestId.length);
          } else {
            throw new Error("RequestId n√£o recebido da API");
          }

          setUploadState("loading", "Imagem recebida! Processando...");
          checkResult();
        } catch (error) {
          console.error("‚ùå Erro no upload:", error);
          setUploadState("error", "Falha no envio: " + error.message);
        }
      }

      async function checkResult() {
        if (!requestId) {
          console.error("‚ùå Nenhum requestId dispon√≠vel");
          return;
        }

        const cleanRequestId = requestId.trim().replace(/\s+/g, "");

        console.log("üîç Verificando resultado para requestId:", cleanRequestId);
        console.log("üìè Comprimento do requestId:", cleanRequestId.length);

        try {
          const queryUrl = `${API_URL}/result?requestId=${encodeURIComponent(cleanRequestId)}`;
          console.log("üì° URL da consulta:", queryUrl);

          const response = await fetch(queryUrl);
          console.log("üìä Status da resposta:", response.status);

          if (!response.ok) {
            const errorText = await response.text();
            console.error("‚ùå Texto do erro:", errorText);
            throw new Error(`HTTP ${response.status}`);
          }

          const data = await response.json();
          console.log("‚úÖ Dados recebidos:", data);

          if (data.success === false) {
            throw new Error(data.error || "Erro na consulta");
          }

          const resultData = data.data || data;
          const status = resultData.status;

          console.log("üìù Status atual:", status);

          if (status === "PROCESSING" || status === "ANALYZING_IMAGE" || status === "GENERATING_RECIPES") {
            const message = resultData.message || getStatusMessage(status);
            setUploadState("loading", message);
            console.log("‚è≥ Ainda processando, verificando novamente em 3s...");
            setTimeout(checkResult, 3000);
          } else if (status === "COMPLETED") {
            console.log("üéâ Processamento completo! Mostrando receitas...");
            showResult(resultData.recipes);
          } else if (status === "ERROR") {
            throw new Error(resultData.errorMessage || "Erro no processamento");
          } else {
            console.warn("‚ö†Ô∏è Status desconhecido:", status);
            setUploadState("loading", "Processando...");
            setTimeout(checkResult, 3000);
          }
        } catch (error) {
          console.error("üí• Erro ao verificar resultado:", error);

          if (error.message.includes("HTTP 400")) {
            setUploadState("error", "Erro na consulta. Por favor, recarregue a p√°gina e tente novamente.");
          } else {
            setUploadState("error", "Erro ao verificar resultado: " + error.message);

            setTimeout(checkResult, 5000);
          }
        }
      }

      function setUploadState(type, message) {
        statusDiv.textContent = message;
        statusDiv.className = type;
        statusDiv.style.display = "block";
        uploadButton.disabled = type === "loading";
      }

      function showResult(recipes) {
        setUploadState("success", "Pronto! Suas receitas est√£o abaixo.");
        resultadoDiv.innerHTML = formatRecipes(recipes);
        resultadoDiv.style.display = "block";
        uploadButton.disabled = false;
      }

      function formatRecipes(recipes) {
        if (!recipes) return "<p>Nenhuma receita encontrada.</p>";
        return recipes
          .split("\n")
          .map((line) => {
            if (line.includes("**")) {
              return `<h3>${line.replace(/\*\*/g, "")}</h3>`;
            }
            return `<p>${line}</p>`;
          })
          .join("");
      }
    </script>
  </body>
</html>
